name: Auto Merge Contributors

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the PR branch (fixes detached HEAD issue)
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # 2️⃣ Get the list of added files
      - name: Get added files
        id: files
        uses: tj-actions/changed-files@v44

      # 3️⃣ Validate contributor file (.txt inside contributors/)
      - name: Validate contributor file
        id: validate
        run: |
          VALID=false
          for file in ${{ steps.files.outputs.added_files }}; do
            if [[ "$file" =~ ^[Cc]ontributors/[^/]+\.txt$ ]]; then
              VALID=true
              echo "CONTRIBUTOR_FILE=$file" >> $GITHUB_ENV
              break
            fi
          done

          if [ "$VALID" = false ]; then
            echo "❌ No valid contributor file found."
            exit 1
          fi

      # 4️⃣ Extract contributor name (first line of the .txt file)
      - name: Extract contributor name
        run: |
          NAME=$(head -n 1 "$CONTRIBUTOR_FILE")
          echo "NAME=$NAME" >> $GITHUB_ENV

      # 5️⃣ Update README.md
      - name: Update README
        run: |
          # Insert contributor after <!-- CONTRIBUTORS-LIST -->
          sed -i "/<!-- CONTRIBUTORS-LIST -->/a - $NAME" README.md

      # 6️⃣ Commit README update
      - name: Commit README update
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Add contributor: $NAME" || echo "No changes to commit"
          git push

      # 7️⃣ Auto-merge PR
      - name: Auto-merge PR
        uses: pascalgn/automerge-action@v0.16.3
        with:
          merge-method: squash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
